<?php
/** @var TouchShop\PowerUser\Block\PowerUser $block */

?>
<link rel="stylesheet" type="text/css"
      href="<?php echo $block->getViewFileUrl("TouchShop_Basic::css/common.css") ?>">
<link rel="stylesheet" type="text/css"
      href="<?php echo $block->getViewFileUrl("TouchShop_PowerUser::css/PowerUser.css") ?>">
<form action="<?php echo $block->getFormAction() ?>" method="post" class="power-user-form">

    <div class="power-user-banner">
        <img src="<?php echo $block->getBaseImgUrl('power-user-banner.jpg') ?>" alt="">
    </div>

    <div class="input-container-title">We'd love to learn more about you so that we can offter products that are most
        relaevant to your interests.
    </div>
    <div class="input-container">
        <label for="email">I am interested in:</label>
        <div class="input-container input-container-full">
            <div class="input-checkbox-container">
                <div><input type="checkbox" name="interests[]" value="USB Hubs and Adapters"> TV Accessories</div>
                <div><input type="checkbox" name="interests[]" value="Cell Phone Batteries"> Home Decoration</div>
                <div><input type="checkbox" name="interests[]" value="USB Wall/car Chargers"> Stage Lighting & Effects
                </div>
                <div><input type="checkbox" name="interests[]" value="Screen Protectors"> Home Security</div>
                <div><input type="checkbox" name="interests[]" value="Phone/Tablet Cases"> Accessories</div>
                <div><input type="checkbox" name="interests[]" value="Portable Chargers"> Power</div>
                <div><input type="checkbox" name="interests[]" value="Phone/Laptop Batteries"> Health</div>
                <div><input type="checkbox" name="interests[]" value="Keyboards and Mice"> Audio & Sounds</div>
            </div>
        </div>
    </div>

    <div class="input-container-title input-container-title-noBold">The fields marked <span>*</span> are required.</div>
    <div class="input-container-title">Power User Infomation</div>

    <div class="input-container">
        <div class="form-action-control-container">
            <div class="control1">

                <label for="text">Email address <span>*</span>
                    <input name="email" id="powerUserEmail" type="email" required="required" autocomplete="off">
                </label>
            </div>
            <div class="power-user-hint"></div>
            <div class="power-user-pwd1">

                <label for="password">Password <span>*</span>
                    <input name="password" id="powerUserPwd1" type="password" required="required" autocomplete="off">
                </label>
            </div>

            <div class="power-user-pwd2">

                <label for="password">Please enter your Password again<span>*</span>
                    <input name="password" id="powerUserPwd2" type="password" required="required" autocomplete="off">
                </label>
            </div>

            <div class="form-action-btn">
                <button type="reset">RESET</button>
                <button type="submit">SUBMIT</button>
            </div>
        </div>
    </div>
</form>

<script>
    (function () {
        require(['jquery'], function ($) {
            var data = <?php echo($block->getAjax())?>;
            var vip = data.vip;
            // var vip = 1;
            // console.log(vip);
            var email = data.email || '12321@qq.com';
            var interests = data.interests || ['USB Hubs and Adapters', 'Cell Phone Batteries'];
            var powerUserEmail = $("#powerUserEmail");
            var inputCheckBox = $(".input-checkbox-container input");
            var powerUserPwd1Con = $(".form-action-control-container .power-user-pwd1");
            var powerUserPwd2Con = $(".form-action-control-container .power-user-pwd2");
            var powerUserPwd1 = $("#powerUserPwd1");
            var powerUserPwd2 = $("#powerUserPwd2");
            var submitBtn = $(".form-action-btn button[type='submit']");
            var vip1 = 0;
            var hint = $(".power-user-hint");
            var emailRegExp = new RegExp('^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\\.[a-zA-Z0-9_-]+)+$');
            // var hiddenSubmit = $(".form-action-control-container input[type= 'submit']");
            $(function () {
                console.log(vip);
                //vip == 2
                if (vip == 2) {
                    // interests
                    inputCheckBox.each(function (index, e) {
                        if (interests.indexOf($(e).val()) != -1) {
                            $(e).attr("checked", "checked");
                        }
                    });
                    // email
                    $("#powerUserEmail").attr({"placeholder": email, "disabled": "disabled"});
                    submitBtn.off("click");
                    submitBtn.click(function () {
                        $(".power-user-form").submit();
                    })

                }
                //vip == 1
                else if (vip == 1) {
                    // hint.text("you have submit successfully, thanks for your feedback")
                    $("#powerUserEmail").attr({"placeholder": email, "disabled": "disabled"});
                    submitBtn.off("click");
                    submitBtn.click(function () {
                        console.log("form submit");
                        $(".power-user-form").submit();
                        console.log("form submited");
                    })
                }

                // vip == 0
                else {

                    // powerUserEmail.removeAttrs("disabled");

                    powerUserEmail.blur(function () {
                        if (emailRegExp.test(powerUserEmail.val())) {


                            if (powerUserEmail.val() != "") {
                                console.log("email blured");
                                let url = "<?php echo $block->getBaseUrl() . 'power-user/hasSignUp/index'?>";
                                let param = {
                                    email: powerUserEmail.val()
                                };
                                sendAjax(url, param, function (res) {
                                    let vip1 = res.vip;
                                    console.log(vip1);
                                    //display logic
                                    if (vip1 == 0) {
                                        //todo ---signup
                                        hint.text("You haven't registered yet, quickly sign up and submit your interests");
                                        powerUserPwd1Con.css("display", "block");
                                        powerUserPwd2Con.css("display", "block");
                                        powerUserPwd1.val("");
                                        powerUserPwd2.val("");
                                    }
                                    //vip = 1 or 2
                                    else {
                                        //todo ---signin
                                        powerUserPwd1Con.css("display", "block");
                                        powerUserPwd2Con.css("display", "none");
                                        powerUserPwd1.val("");
                                        // $("form").reset();
                                        // console.log(powerUserPwd1.val());
                                        if (vip1 == 1) {
                                            hint.text("You have already registered, quickly sign in and submit your interests");
                                        } else {
                                            hint.text("You are registered power user, quickly sign in and submit your interests");
                                        }
                                    }

                                    //function logic

                                    submitBtn.off("click");
                                    submitBtn.on("click", function (e) {
                                        // e.preventDefault();
                                        // return true;
                                        if (powerUserPwd1Con.css("display") == "block") {
                                            if (powerUserPwd1.val() != "") {

                                                if (vip1 == 0) {

                                                    if (powerUserPwd1.val() == powerUserPwd2.val()) {
                                                        let param = {
                                                            email: powerUserEmail.val(),
                                                            firstname: 'customer',
                                                            lastname: 'user',
                                                            password: 'lq1314588'
                                                        };
                                                        let url = "<?php echo $block->getBaseUrl() . 'basic/account/createPost'?>";
                                                        sendAjax(url, param, function (res) {
                                                            console.log(res);
                                                            if (res.status_code == 200) {
                                                                $(".power-user-form").submit();
                                                            } else {
                                                                hint.text(res.error_message);
                                                            }
                                                        });
                                                    } else {
                                                        hint.text("2 passwords should be equal");
                                                    }
                                                }
                                                //vip1 = 1 or 2
                                                else {

                                                    let param = {
                                                        login: {
                                                            username: powerUserEmail.val(),
                                                            password: powerUserPwd1.val()
                                                        }
                                                    };
                                                    let url = "<?php echo $block->getBaseUrl() . 'basic/account/signInPost'?>"

                                                    sendAjax(url, param, function (res) {
                                                        console.log(res);
                                                        if (res.status_code == 200) {
                                                            $(".power-user-form").submit();
                                                        } else {
                                                            hint.text(res.error_message);
                                                        }
                                                    });
                                                }
                                            }
                                            else {
                                                hint.text("password cannot be empty");
                                            }
                                        }
                                    });
                                })
                            }

                        } else {
                            hint.text("invalid email format");
                        }
                    });
                    powerUserEmail.focus(function () {
                        hint.text(" ");
                    });
                }


                function sendAjax(url, param, ajaxHandler) {
                    console.log("sendAjax in");
                    var responseText = $.ajax({
                        url: url,
                        type: "POST",
                        // dataType: "json",
                        data: param,
                        success: function (res) {
                            console.log("ajax ok");
                            console.log("res", res);
                            ajaxHandler(res);
                        },
                        error: function (jqXHR, textstatus, errorThrown) {
                            console.log(jqXHR, textstatus, errorThrown);
                            console.log("ajax error");
                        }
                    });
                }
            })
        })
    })();
</script>