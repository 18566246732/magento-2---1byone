<?php
/**@var $block TouchShop\Support\Block\SupportBlock */
$products = $block->getProducts();
?>

<!--this should be added globally inside head tag-->
<!--suppress JSAnnotator -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.4/css/bootstrap.min.css">

<link rel="stylesheet" href="<?php echo $block->getViewFileUrl("TouchShop_Support::css/support.css")?>">
<div class="catalog-panel">
    <div class="catalog-header">
<!--        support/Index/index.php == support-->
        <form method="post">
            <lable>Search by Product Name/SKU</lable>
            <div class="input-group" >
                <input type="text" placeholder="find what you what ...">
                <input type="button" id="supportSearch" value="search"/>
            </div>
        </form>
    </div>
    <div class="main">
        <div class="flex-container">
            <div class="flex-item">
                <div class="post">
                    <img src="" alt="" draggable="false">
                    <h3></h3>
                </div>
                <div class="post-cover">
                    <a href="">FAQ >></a>
                    <a href="">Products Details >></a>
                    <span>x</span>
                    <h3>Download List</h3>
                    <ul>
                    </ul>
                </div>
            </div>
            <div class="flex-item">
                <div class="post">
                    <img src="" alt="" draggable="false">
                    <h3></h3>
                </div>
                <div class="post-cover">
                    <a href="">FAQ >></a>
                    <a href="">Products Details >></a>
                    <span>x</span>
                    <h3>Download List</h3>
                    <ul>
                    </ul>
                </div>
            </div>
            <div class="flex-item">
                <div class="post">
                    <img src="" alt="" draggable="false">
                    <h3></h3>
                </div>
                <div class="post-cover">
                    <a href="">FAQ >></a>
                    <a href="">Products Details >></a>
                    <span>x</span>
                    <h3>Download List</h3>
                    <ul>
                    </ul>
                </div>
            </div>
            <div class="flex-item">
                <div class="post">
                    <img src="" alt="" draggable="false">
                    <h3></h3>
                </div>
                <div class="post-cover">
                    <a href="">FAQ >></a>
                    <a href="">Products Details >></a>
                    <span>x</span>
                    <h3>Download List</h3>
                    <ul>
                    </ul>
                </div>
            </div>
            <div class="flex-item">
                <div class="post">
                    <img src="" alt="" draggable="false">
                    <h3></h3>
                </div>
                <div class="post-cover">
                    <a href="">FAQ >></a>
                    <a href="">Products Details >></a>
                    <span>x</span>
                    <h3>Download List</h3>
                    <ul>
                    </ul>
                </div>
            </div>
            <div class="flex-item">
                <div class="post">
                    <img src="" alt="" draggable="false">
                    <h3></h3>
                </div>
                <div class="post-cover">
                    <a href="">FAQ >></a>
                    <a href="">Products Details >></a>
                    <span>x</span>
                    <h3>Download List</h3>
                    <ul>
                    </ul>
                </div>
            </div>
            <div class="flex-item">
                <div class="post">
                    <img src="" alt="" draggable="false">
                    <h3>this is a</h3>
                </div>
                <div class="post-cover">
                    <a href="">FAQ >></a>
                    <a href="">Products Details >></a>
                    <span>x</span>
                    <h3>Download List</h3>
                    <ul>
                    </ul>
                </div>
            </div>
            <div class="flex-item">
                <div class="post">
                    <img src="" alt="" draggable="false">
                    <h3></h3>
                </div>
                <div class="post-cover">
                    <a href="">FAQ >></a>
                    <a href="">Products Details >></a>
                    <span>x</span>
                    <h3>Download List</h3>
                    <ul>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="footer">
        <div class="pagination">
            <ul id="pagination-demo" class="pagination-sm"></ul>
        </div>
    </div>
</div>

<script>
    (function () {
        // var paginationClicked = false;
        require(["jquery", "twbsPagination"], function ($) {
            $(document).ready(function () {
                console.log("require working....");

                $("#supportSearch").on("click", function (e) {
                    //console.log("search clicked !",<?php //echo json_encode($products)?>//);
                    fuck(e, 1);
                });
                var currentPage = 1,
                    imgArr = $(".flex-item img"),
                    fileContainer = $(".flex-item ul"),
                    prodName = $(".flex-item .post h3"),
                    closeBtn = $(".flex-item .post-cover span"),
                    post = $(".flex-item .post"),
                    postCover = $(".flex-item .post-cover"),
                    aArr = $(".flex-item .post-cover a"),
                    faq = aArr[0],
                    prodDetails = aArr[1];

                closeBtn.on("click",function () {
                    // console.log("closeBtn", this);
                    let postCover= $(this).parent();
                    postCover.css("display", "none");
                });

                post.on("click", function () {
                    post.next().css("display","none");
                    // console.log("flexItem", this);
                    let postCover = $(this).next();
                    postCover.css("display", "flex");
                });
                
                // paginatinoIni(1, currentPage);

                fuck(currentPage, imgArr, fileContainer, prodName, faq, prodDetails);
                console.log("done");

                $("#pagination-demo").on("click",function () {
                    fuck(currentPage, imgArr, fileContainer, prodName, faq, prodDetails);
                });

            });

            function paginatinoIni(totalP, currentPage) {
                console.log(totalP);
                $('#pagination-demo').twbsPagination({
                    totalPages: totalP,
                    visiblePages: 7,
                    prev: "<",
                    next: ">",
                    firstClass: "first-btn",
                    lastClass: "last-btn",
                    paginationClass: "pagination-overall",
                    onPageClick: function (e, page) {
                        // fuck(e, page, imgArr, fileContainer, prodName);
                        currentPage = page;
                    },
                });
            }


            function fuck(page, imgArr, fileContainer, prodName, faq, prodDetails) {
                console.log("fuck in");
                console.log(page, imgArr);
                var responseText = $.ajax({
                    url: "<?php echo $block->getUrl('support') ?>",
                    type: "POST",
                    dataType: "json",
                    data: {
                        key: $(".input-group input[type='text']").val(),
                        page_num: page,
                        page_size: 8
                    },
                    success: function (res) {
                        console.log("ajax ok");
                        console.log(res);
                        display(res, imgArr, fileContainer, prodName, faq, prodDetails);
                    },
                    error: function (jqXHR,textstatus, errorThrown) {
                        console.log(jqXHR,textstatus,errorThrown);
                        console.log("ajax error");
                    }
                });
                // console.log(responseText,"outside");
            }

            function display(res, imgArr, fileContainer, prodName, faq, prodDetails) {
                // console.log(res.total, res.products);
                let total = res.total_count;
                let productsArr = res.products;
                let totalP = Math.ceil(total/8);
                paginatinoIni(totalP);
                // console.log(totalP);
                // console.log(imgArr);
                imgArr.each(function (index,ele) {
                    // console.log(ele, productArr[index].image);
                    ele.src = "../" + productsArr[index].image;
                    // console.log(ele.src);
                    let resHtml = "";
                    let dFiles = productsArr[index].download_files;
                    let dataPName = productsArr[index].product_name;
                    let dataFAQ = productsArr[index].faq;
                    let dataUrl = productsArr[index].url;
                    // console.log(dFiles, dataPName);
                    dFiles.forEach(function (ele) {
                        // console.log(ele);
                        resHtml += "<li><a href= ../"+ele.src + ">"+ ele.label + " >> </a></li>";
                    });
                    // console.log(fileContainer,$(fileContainer[index]),resHtml);
                    $(fileContainer[index]).html(resHtml);
                    $(prodName).text(dataPName);
                    $(faq).attr("href", dataFAQ);
                    $(prodDetails).attr("href", dataUrl);
                });
            }
        });
    })()
</script>