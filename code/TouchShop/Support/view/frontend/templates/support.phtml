<?php
/**@var $block TouchShop\Support\Block\SupportBlock */
?>

<!--this should be added globally inside head tag-->
<!--suppress JSAnnotator -->
<!--<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.4/css/bootstrap.min.css">-->

<link rel="stylesheet" href="<?php echo $block->getViewFileUrl("TouchShop_Support::css/bootstrap.min.css") ?>">

<link rel="stylesheet" href="<?php echo $block->getViewFileUrl("TouchShop_Support::css/simplePagination.css") ?>">
<link rel="stylesheet" href="<?php echo $block->getViewFileUrl("TouchShop_Support::css/simplePaginationOverwrite.css") ?>">
<link rel="stylesheet" href="<?php echo $block->getViewFileUrl("TouchShop_Support::css/support.css") ?>">
<div class="catalog-panel">
    <div class="catalog-header">
        <form method="post">
            <lable>Search by Product Name/SKU</lable>
            <div class="input-group">
                <input type="text" placeholder="find what you what ...">
                <input type="button" id="supportSearch" value="search"/>
            </div>
        </form>
    </div>
    <div class="main">
        <div class="flex-container">
            <?php $index = 8; ?>
            <?php while ($index-- > 0): ?>
            <div class="flex-item">
                <div class="post">
                    <img src="" alt="" draggable="false">
                    <h3></h3>
                </div>
                <div class="post-cover">
                    <a href="#">FAQ >></a>
                    <a href="#" class="product-details">Products Details >></a>
                    <span>x</span>
                    <h3>Download List</h3>
                    <ul>
                    </ul>
                </div>
            </div>
            <?php endwhile;?>
        </div>
    </div>
    <div class="footer">
        <div class="pagination">
            <ul id="pagination-demo" class="pagination-sm"></ul>
        </div>
    </div>

    <div class="catalog-panel-background"></div>

    <div class="faq-cover">
        <div class="faq-info">
            <span>x</span>
            <div class="faq-block">
                <div class="question"></div>
                <div class="answer"></div>
            </div>
        </div>
    </div>

</div>

<script>
    (function () {

        require(["jquery", "simplePagination"], function ($) {

            var currentPage = 1,
                imgArr = $(".flex-item img"),
                fileContainer = $(".flex-item ul"),
                prodName = $(".flex-item .post h3"),
                closeBtn = $(".flex-item .post-cover span"),
                post = $(".flex-item .post"),
                postCover = $(".flex-item .post-cover"),
                faq = $(".flex-item .post-cover a:first-child"),
                prodDetails = $(".flex-item .post-cover .product-details"),
                faqCover = $(".faq-cover"),
                faqInfo = $(".faq-info"),
                faqCloseBtn = $(".faq-info > span"),
                faqQ = $(".faq-info .question"),
                faqA = $(".faq-info .answer"),
                paginationItem = $(".pagination-demo ul"),
                searchInput = $(".catalog-header .input-group input:first-child");
                currentPage = 1,
                isSearching = false,
                isPageIni = false,

            $(document).ready(function () {
                console.log("require working....");


                faqCloseBtn.on("click", function () {
                    faqCover.css("display", "none");
                });

                closeBtn.on("click", function () {
                    let postCover = $(this).parent();
                    postCover.css("display", "none");
                });

                post.on("click", function () {
                    post.next().css("display", "none");
                    let postCover = $(this).next();
                    postCover.css("display", "flex");
                });

                //1. page first loaded , send ajax, display result

                sendAjax(currentPage);
                isPageIni = true;
                //2. click pagination item, send ajax,  finished on pagenationIni callback



                //3. click search button , send ajax
                $("#supportSearch").on("click", function (e) {
                    isSearching = true;
                    sendAjax(1);
                });

                $(document).keypress(function (e) {
                    if(e.which == 13 && searchInput.is(":focus")) {
                        e.preventDefault();
                        $("#supportSearch").click();
                    }
                })


            });

            function paginatinoIni(total) {
                $("#pagination-demo").pagination({
                    items: total,
                    itemsOnPage: 8,
                    currentPage: 1,
                    cssStyle: '',
                    prevText: '<span>&laquo;</span>',
                    nextText: '<span>&raquo;</span>',
                    onPageClick: function (page, e) {
                        //2. click pagination , send ajax
                            sendAjax(page);
                    },
                })
            }

            function sendAjax(page) {
                console.log("sendAjax in");
                var responseText = $.ajax({
                    url: "<?php echo $block->getUrl('support') ?>",
                    type: "POST",
                    dataType: "json",
                    data: {
                        key: $(".input-group input[type='text']").val(),
                        page_num: page,
                        page_size: 8
                    },
                    success: function (res) {
                        console.log("ajax ok");
                        console.log(res, page);
                        display(res, page);
                    },
                    error: function (jqXHR, textstatus, errorThrown) {
                        console.log(jqXHR, textstatus, errorThrown);
                        console.log("ajax error");
                    }
                });
            }


            function display(res, currentPage) {
                // hide all posts
                post.css("visibility", "hidden");
                let total = res.total_count;

                if (total == 0) {
                    console.log("data is zero");
                } else {
                    let productsArr = res.products;
                    // let totalP = Math.ceil(total / 8);

                    if(isSearching || isPageIni ) {
                        // twbsPagination totalPage refresh
                        //1. remove target element
                        // $("#pagination-demo").remove();
                        //2. add it from it's parent
                        // $(".footer > .pagination").append("<ul id=\"pagination-demo\" class=\"pagination-sm\"></ul>");
                        //3. re-initialize
                        paginatinoIni(total);

                        console.log("pagini");
                    }

                    isSearching = false;
                    isPageIni = false;

                    imgArr.each(function (index, ele) {
                        if(index <= total -1) {
                            $(post[index]).css("visibility", "visible");
                            console.log(productsArr, index);
                            ele.src = "../" + productsArr[index].image;
                            // console.log(ele.src);
                            let resHtml = "";
                            let dFiles = productsArr[index].download_files;
                            let dataPName = productsArr[index].product_name;
                            let dataFAQ = productsArr[index].faq;
                            let dataUrl = productsArr[index].url;
                            // console.log(dFiles, dataPName);
                            dFiles.forEach(function (ele) {
                                // console.log(ele);
                                resHtml += "<li><a href= ../" + ele.src + ">" + ele.label + " >> </a></li>";
                            });
                            $(fileContainer[index]).html(resHtml);
                            $(prodName).text(dataPName);
                            $(faq[index]).on("click", function () {
                                // console.log(faqQ,faqA);
                                faqCover.css("display", "block");
                                $(faqQ).text(dataFAQ[0].question);
                                $(faqA).text(dataFAQ[0].answer);
                            });
                            $(prodDetails[index]).attr("href", dataUrl);
                        } else {
                            return false;
                        }
                    });
                }
            }
        });
    })()
</script>